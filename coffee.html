<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coffee Reviews</title>
</head>
<body>
  <h1>Coffee Review</h1>
  <form id="reviewForm">
    <label>Coffee Shop: <input name="shop" required /></label><br/>
    <label>Location: <input name="location" required /></label><br/>
    <label>Date: <input name="date" type="date" required /></label><br/>
    <label>Notes: <textarea name="notes" required></textarea></label><br/>
    <label>Rating: <input name="rating" type="number" step="0.1" min="0" max="5" required /></label><br/>
    <label>Image: <input name="image" type="file" accept="image/*" /></label><br/>
    <button type="submit">Submit</button>
  </form>

  <h2>All Reviews</h2>
  <div id="reviews"></div>

  <script>
    const apiURL = "https://script.google.com/macros/s/AKfycbyXg6ilSnT7-HpOp6kTE-PTlcNiGTaL4ipGxSKBg2cvSEbHCoId7bTMJFX_lICJaO3bVw/exec";

    document.getElementById("reviewForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const fileInput = form.image.files[0];

      if (fileInput) {
        const reader = new FileReader();
        reader.onload = async () => {
          const base64Image = reader.result.split(',')[1];
          const payload = new FormData();
          payload.append("shop", form.shop.value);
          payload.append("location", form.location.value);
          payload.append("date", form.date.value);
          payload.append("notes", form.notes.value);
          payload.append("rating", form.rating.value);
          payload.append("image", base64Image);
          payload.append("filename", fileInput.name);
          payload.append("mimeType", fileInput.type);

          try {
            const res = await fetch(apiURL, {
              method: "POST",
              body: payload
            });
            const data = await res.json();
            console.log("Upload response:", data);
            alert("Review submitted successfully!");
            loadReviews();
          } catch (err) {
            console.error("Submission error:", err);
            alert("Failed to submit review.");
          }
        };
        reader.readAsDataURL(fileInput);
      } else {
        const payload = new FormData(form);
        try {
          const res = await fetch(apiURL, {
            method: "POST",
            body: payload
          });
          const data = await res.json();
          console.log("Upload response (no image):", data);
          alert("Review submitted successfully!");
          loadReviews();
        } catch (err) {
          console.error("Submission error:", err);
          alert("Failed to submit review.");
        }
      }
    });

    async function loadReviews() {
      try {
        const res = await fetch(apiURL);
        const reviews = await res.json();
        console.log("Fetched reviews:", reviews);

        const container = document.getElementById("reviews");
        container.innerHTML = "";
        reviews.forEach(([shop, location, date, notes, rating, imageUrl]) => {
          const div = document.createElement("div");
          div.innerHTML = `
            <p><strong>${shop}</strong> (${location}, ${date})<br/>
            Rating: ${rating}/5<br/>
            ${notes}<br/>
            ${imageUrl ? `<img src="${imageUrl}" style="max-width:200px;" />` : ""}</p><hr/>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error("Load reviews error:", err);
      }
    }

    loadReviews();
  </script>
</body>
</html>
